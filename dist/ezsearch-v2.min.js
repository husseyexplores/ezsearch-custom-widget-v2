(function(A,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):(A=typeof globalThis<"u"?globalThis:A||self,T(A.EZSearchV2={}))})(this,function(A){"use strict";var T=Object.defineProperty,j=(n,e,i)=>e in n?T(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i,I=(n,e,i)=>(j(n,typeof e!="symbol"?e+"":e,i),i),z=(n,e,i)=>new Promise((s,t)=>{var r=a=>{try{o(i.next(a))}catch(d){t(d)}},l=a=>{try{o(i.throw(a))}catch(d){t(d)}},o=a=>a.done?s(a.value):Promise.resolve(a.value).then(r,l);o((i=i.apply(n,e)).next())});class U extends HTMLElement{constructor(){super(),this._connected=!1,this._ac=null,this.is_mounted=!1}connectedCallback(){return z(this,null,function*(){if(this._connected=!0,yield Promise.resolve(),!this._connected)return;this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=new AbortController;let e=this.mount();e instanceof Promise&&(e=yield e),e===!0&&this._aftermount(),this.is_mounted=!0})}mount(){return!0}unmount(){}_aftermount(){this.setAttribute("hydrated","true")}_afterunmount(){this.setAttribute("hydrated","false")}disconnectedCallback(){return z(this,null,function*(){this._connected=!1,yield Promise.resolve(),!this._connected&&(this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=null,this.unmount(),this._afterunmount(),this.is_mounted=!1)})}}const G=n=>Object.prototype.toString.call(n).slice(8,-1),J=n=>G(n)==="Object";let F="[EZSearch] :: ";function C(...n){return console.log(F,...n)}C.warn=(...n)=>console.warn(F,...n),C.info=(...n)=>console.info(F,...n),C.error=(...n)=>console.error(F,...n);const k={};function D(n,e){return z(this,null,function*(){const i=n.replace(/\\\//g,"/");if(k[i])return k[i].then(t=>e(t.clone()));const s=fetch(i);return k[i]=s,s.then(t=>e(t.clone()))})}function Y(n){let e=[],i=!1;for(let s=0,t=0,r=0;r<n.length;r++){let l=n[r],o=n[r+1];if(e[s]=e[s]||[],e[s][t]=e[s][t]||"",l=='"'&&i&&o=='"'){e[s][t]+=l,++r;continue}if(l=='"'){i=!i;continue}if(l==","&&!i){++t;continue}if(l=="\r"&&o==`
`&&!i){++s,t=0,++r;continue}if(l==`
`&&!i){++s,t=0;continue}if(l=="\r"&&!i){++s,t=0;continue}e[s][t]+=l}return e}function Z(n){return z(this,null,function*(){return yield D(n,e=>z(this,null,function*(){if(!e.ok)throw new Error("ezsearch: Unable to fetch CSV");const i=yield e.text();return Y(i)}))})}function X(n,e="null"){try{return JSON.parse(n||e)}catch{return typeof e=="string"?JSON.parse(e):e}}function Q(n,e){let i=0,s=null;return e.forEach((t,r)=>{r===n&&s==null&&(s=i),i++}),s}function ee(n){return n[n.length-1]}const m={ATTR:{id:"data-ezs-id",legacy_search:"data-legacy-search",filter:"data-ezs-filter",config_url:"data-ezs-config-url",coll_handle:"data-ezs-collection-handle",reset_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",item_title:"data-ezs-item-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_selection:"data-ezs-clear-selection",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function P(n,e,i=0){if(J(n)){let s=Object.keys(n);s.forEach(t=>{let r=n[t];P(r,e,i+1)}),e(n,s,i)}return Array.isArray(n)&&n.forEach(s=>{P(s,e,i)}),n}function te({data:n,keys:e=[],path:i=[],keysSort:s=[]}){let t={};return e.forEach((r,l)=>{let o=l===e.length-1;n.forEach(a=>{if(!a)return;let d=i.reduce((g,w)=>g[w],a);if(!d)return;let c=d[r];if(typeof c=="number"&&(c=c.toString()),typeof c!="string"||c==="")return;let u=e.slice(0,l).reduce((g,w)=>g[d[w]],t);if(u)if(o){const g=new $(a);u[c]?Array.isArray(u[c])?u[c].push(g):u[c]=[u[c],g]:u[c]=g}else u[c]={}})}),Object.keys(t).length>0?P(t,(r,l,o)=>{var a;if(!r._tag){const d=(a=s[o])==null?void 0:a.desc;r._keys_=l.sort((c,u)=>d?u.localeCompare(c):c.localeCompare(u))}}):t}function se(n,e){if(e<0||e>=n.length)return!1;let i=n.slice(0,e);return Array.isArray(n[0])?i.every(([t,r])=>!!r):i.every(t=>!!t)}function ie({selectedValues:n,index:e,filterTree:i}){let s=se(n,e);if(!s)return null;if(s){const t=Array.isArray(n[0]);return n.slice(0,e).reduce((l,o)=>{if(l==null)return null;let a=t?o[1]:o;return l[a]},i)}}function ne({keys:n,filterTree:e,activeFilters:i}){return n.reduce((s,t)=>{let r=i.get(t);return r&&s?.[r]||null},e)}class ${constructor(e){this.value=e}}const R=n=>`ezs_${n}`,H=n=>`${n}__expiresIn`;function O(n){const e=R(n);return window.localStorage.removeItem(e),window.localStorage.removeItem(H(e)),!0}function L(n){const e=R(n);let i=Date.now();return Number(window.localStorage.getItem(H(e))||"0")<i?(O(e),null):window.localStorage.getItem(e)}function q(n,e,i=60*5){const s=R(n);i=Math.abs(i);let r=Date.now()+i*1e3;return window.localStorage.setItem(s,e),window.localStorage.setItem(H(s),r),!0}const B=window.EzsearchGlobalV2Options,K={},N=[],x=class E extends U{constructor(){if(super(),this.uid=this.id||this.getAttribute(m.ATTR.id),!this.uid)throw new Error(`ezsearch: id must be specified (\`id\` | \`${m.ATTR.id}\`)`);this.elements={form:null,selects:null,toggleOpen:null,submitBtns:null,resetBtns:null,itemTitles:null,filteredHrefs:null},this.options=null,this.singletonData=null,this.state={activeFilters:null,allSelected:!1,selectedItem:null,selectedItemTitle:null,filteredCollectionHref:null},this._handleChange=this._handleChange.bind(this),this._handleChangeFn=this._handleChangeFn.bind(this)}subscribe(e,i=!0){var s;const t=(s=this.singletonData)==null?void 0:s.subscribers;if(!t)throw new Error("ezsearch: not initialized");return t.push(e),i!==!1&&e(this.state),()=>{var r;const l=(r=this.singletonData)==null?void 0:r.subscribers;if(!l)throw new Error("ezsearch: not initialized");const o=l.indexOf(e);o>-1&&l.splice(o,1)}}_runSubscribers(){const e=this.singletonData.subscribers;for(let i=0,s=e.length;i<s;i++){const t=e[i];t(this.state)}}mount(){return z(this,null,function*(){var e,i;this.elements.form=this.querySelector("form[data-ezs-form]"),this.elements.selects=Array.from(this.querySelectorAll("select[data-ezs-filter]")),this.elements.toggleOpen=Array.from(this.querySelectorAll("[data-ezs-toggle-open]")),this.elements.submitBtns=Array.from(this.elements.form.querySelectorAll('[type="submit"]')),this.elements.resetBtns=Array.from(this.querySelectorAll('[data-ezs-goto-mode="selection"]')),this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.options=le(this);const{configUrl:s,filterKeys:t,canCache:r,preClearCache:l}=this.options;let o=K[this.uid];if(o||(N.push(this.uid),o={subscribers:[],data:null},K[this.uid]=o,this.singletonData=o,E.instances.includes(this)||E.instances.push(this)),!o.data){const a=yield D(s,c=>c.json()),d=(i=(e=a?.settings)==null?void 0:e.form)==null?void 0:i.db;if(!d)throw console.log("ezsearch: data",o.data),new Error("ezsearch: unable to fetch db url");o.data=yield Z(d).then(c=>ae(c,this.options))}return this.state.activeFilters=new Map(Array.from({length:t.length},(a,d)=>[t[d],!r||l?"":L(t[d])||""])),this._setupListeners(),!0})}unmount(){}_updateOptions({selectIndex:e,updateSelectValue:i=!1,forcePending:s=!1}){let t=[...this.state.activeFilters];t.forEach(([r,l],o)=>{const a=ie({selectedValues:t,index:o,filterTree:this.singletonData.data.tree});a?.[l]||this.state.activeFilters.set(r,"");const d=o>e,c=this.elements.selects[o],u=a?._keys_||[],g=Array.isArray(u)&&u.length>0;c.disabled=!g,this.options.canCache&&(l?q(r,l,this.options.cacheSeconds):O(r)),(e===-1||i?!1:d?this.options.resetNextSelectsOnChange?!1:u.length===c.options.length-1&&u.every((h,f)=>h===c.options[f+1].value):!0)||(c.options.length=1,requestAnimationFrame(()=>{u.forEach((h,f)=>{c.options[f+1]=new Option(h,h)}),c.value=this.state.activeFilters.get(r)||""}))}),this.state.allSelected=[...this.state.activeFilters].every(([,r])=>!!r),this.setAttribute("data-ezs-selected-filters",this.state.allSelected?"all":"partial"),this.state.allSelected||this.setAttribute("data-ezs-state","pending"),(s||e===-1)&&this._afterOptionsUpdate({forcePending:s}),this.state.allSelected&&this.options.autoSearch&&this.elements.form.dispatchEvent(new Event("submit")),this.dispatchEvent(new CustomEvent("ezsearch::selection_update",{detail:{index:e,select:this.elements.selects[e]},bubbles:!1,cancelable:!1}))}_afterOptionsUpdate({forcePending:e=!1,fromCache:i=!1}={}){const s=e?null:i?X(L("selectedItem"),"null"):ne({keys:this.options.filterKeys,activeFilters:this.state.activeFilters,filterTree:this.singletonData.data.tree}),t=s instanceof $?s.value:null,r=t?._path||"";this.state.selectedItem=t,this.state.selectedItemTitle=t?this.options.filterKeys.map(l=>this.state.activeFilters.get(l)).join(" "):"",this.state.filteredCollectionHref=r,this.setAttribute("data-ezs-state",t?"selected":"pending"),t&&this.dispatchEvent(new CustomEvent("ezsearch::selection_complete",{detail:{selected:t},bubbles:!1,cancelable:!1}));for(let l=0,o=this.elements.itemTitles.length;l<o;l++){const a=this.elements.itemTitles[l],d=typeof a.__ezs_fallback_text>"u"?a.__ezs_fallback_text=a.getAttribute("data-fallback-text"):a.__ezs_fallback_text,c=this.state.selectedItemTitle||d;a.textContent=c,c?a.setAttribute("title",c):a.removeAttribute("title")}for(let l=0,o=this.elements.filteredHrefs.length;l<o;l++){const a=this.elements.filteredHrefs[l];a instanceof HTMLAnchorElement&&(a.setAttribute("href",r),a.toggleAttribute("disabled",!r))}this._runSubscribers(),t?q("selectedItem",JSON.stringify(t)):O("selectedItem")}_handleChange(e){var i;const s=e?.isTrusted;let t=(i=e?.target)==null?void 0:i.__ezs_index;if(typeof t!="number"){C.warn("no `__ezs_index` found");return}this._handleChangeFn(t),s&&E.instances.forEach(r=>{r!=this&&(r.elements.selects[t].value=this.elements.selects[t].value,r._handleChangeFn(t))})}_handleChangeFn(e){const i=this.options.filterKeys[e],t=this.elements.selects[e].value;t?this.state.activeFilters.set(i,t):this.state.activeFilters.set(i,""),this.options.resetNextSelectsOnChange&&[...this.state.activeFilters].forEach(([r],l)=>{l>e&&this.state.activeFilters.set(r,"")}),this._updateOptions({selectIndex:e})}_updateFilterValue(e,i){if(!this.state.activeFilters.has(e))return;typeof i=="string"?i=i.trim():i="";let t=Q(e,this.state.activeFilters);t!=null&&(this.state.activeFilters.set(e,i),this._updateOptions({selectIndex:t,updateSelectValue:!0,forcePending:!0}))}_clearAllCache(){O("selectedItem"),this.options.filterKeys.forEach(e=>O(e))}_setupListeners(){this.setAttribute("aria-expanded","false");for(let s=0,t=this.elements.toggleOpen.length;s<t;s++)this.elements.toggleOpen[s].addEventListener("click",()=>{this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")},{signal:this._ac.signal});const e=this.elements.selects;let i=e.map((s,t)=>{s.__ezs_index=t;let r=s.options[0];return r?(r.value="",r):(r=new Option("All","",!0,!0),r)});for(let s=0,t=e.length;s<t;s++){const r=e[s];r.addEventListener("change",this._handleChange,{signal:this._ac.signal}),r.options.length=1,r.options[0]=i[s]}this.elements.form.addEventListener("submit",s=>{s.preventDefault(),s.stopPropagation(),this.state.allSelected&&(this._afterOptionsUpdate(),E.instances.forEach(t=>{t!=this&&t.state.allSelected&&t._afterOptionsUpdate()}))});for(let s=0,t=this.elements.resetBtns.length;s<t;s++){const r=this.elements.resetBtns[s],l=r instanceof HTMLAnchorElement,o=r.getAttribute(m.ATTR.clear_selection)==="true";r.addEventListener("click",()=>{this._resetSelects(o,l),E.instances.forEach(a=>{a!=this&&a._resetSelects(o,l)})})}this._updateOptions({selectIndex:-1})}_resetSelects(e=!1,i=!1){const s=this.elements.selects;e&&(this._clearAllCache(),this._updateFilterValue(this.options.filterKeys[0],"")),i||(this._afterOptionsUpdate({forcePending:!0}),s[0].focus())}fits(e){var i,s,t;if(!((s=(i=this.singletonData)==null?void 0:i.data)!=null&&s.tree))return"loading";const r=(t=this.state.selectedItem)==null?void 0:t._tag;if(!r)return"no-selection";if(typeof e=="string"||Array.isArray(e))return(Array.isArray(e)?e:e.split(",")).includes(r)?"fits":"not-fits";throw new Error("ezsearch: Please pass the `tags` argument (string | string[])")}};I(x,"instancesCache",K),I(x,"widgetIds",N),I(x,"instances",[]);let M=x;function re({tag:n,collectionHandle:e,legacySearch:i}){return i?`/collections/${e||"all"}/${n}`:`/collections/${e||"all"}?filter.p.tag=${n}`}function le(n){const e=Array.from(n.querySelectorAll(`select[${m.ATTR.filter}]`)),i=e.reduce((h,f)=>{const S=f.getAttribute(m.ATTR.filter);return S&&h.push(S.trim()),h},[]);if(i.length<1||e.length!==i.length)throw new Error("ezsearch: Filter keys/selects mismatch");const s=e.map(h=>({desc:h.getAttribute(m.ATTR.sort_by)==="desc"})),t=n.getAttribute(m.ATTR.config_url);if(!t)throw new Error("ezsearch: data-ezs-config-url must be specified");const r=n.getAttribute(m.ATTR.legacy_search)==="true",l=n.getAttribute(m.ATTR.csv_headers)==="true",o=n.getAttribute(m.ATTR.coll_handle)||"all",a=n.getAttribute(m.ATTR.reset_next_selects_on_change)==="true",d=n.getAttribute(m.ATTR.auto_search)==="true",c=B?.filteredProductPathname||re;let u=n.getAttribute(m.ATTR.cache_seconds);typeof u=="string"&&(u=Number(u)||300),u=typeof u=="number"?Math.max(Math.trunc(u),0):0;const g=n.getAttribute(m.ATTR.pre_clear_cache)==="true",w=typeof u=="number"&&!Number.isNaN(u)&&u>0;return{filterSelects:e,filterKeys:i,filterKeysSortBy:s,configUrl:t,hasCsvHeaders:l,collectionHandle:o,createPathname:c,legacySearch:r,cacheSeconds:u,canCache:w,preClearCache:g,resetNextSelectsOnChange:a,autoSearch:d}}function ae(n,e){const{hasCsvHeaders:i,filterKeys:s,collectionHandle:t,createPathname:r,legacySearch:l,filterKeysSortBy:o}=e;(i||s.every((h,f)=>n[0][f]===h))&&(n=n.slice(1));let a=!0,d=s.length,c=s.findIndex(h=>h.toLowerCase()==="year"),u=n;c!==-1&&(u=n.reduce((h,f)=>{const S=f[c];if(!S.includes("-"))return h.push(f),h;let[_,v]=S.split("-").map(p=>Number(p)).reduce((p,b)=>(p.push(Number.isNaN(b)?null:b),p),[]);if(_&&v){for(let p=_;p<=v;p++)h.push(f.map((b,V)=>V===c?p:b));return h}if(!v&&_){const p=_;return h.push(f.map((b,V)=>V===c?p:b)),h}return h},[]));let g=u.map(h=>{if(a&&h.length-1!==d&&(C.error("CSV data and `filterKeys` mismatch",{filterKeys:s,line:h}),a=!1),!a)return[];let f=h[s.length];if(typeof f=="string"){f.startsWith(">>")&&(f=f.slice(2),h[s.length]=f);const y="/collections/all/";if(f.startsWith(y)&&(f=f.slice(y.length)),f.includes("$$$")){const[v]=f.split("$$$");if(v)f=v,h[s.length]=f;else return[]}}return h.reduce((y,_,v)=>{let p=s[v];if(p)y[p]=_;else if(typeof _=="string"){const b=ee(_.split("/"));y._tag=b,y._path=r({tag:b,collectionHandle:t,legacySearch:l})}return y},{})});if(!a)throw new Error("ezsearch: CSV data and `filterKeys` mismatch");return{tree:te({data:g,path:[],keys:s,keysSort:o}),parsedData:g}}class W extends U{constructor(){super(),this.onUpdate=this.onUpdate.bind(this),this.tags=null,this.elements={parentWidget:null,itemTitles:null,filteredHrefs:null}}mount(){const e=this.getAttribute("data-ezs-widget-id");if(!e)throw new Error("ezsearch-fitment: data-ezs-widget-id must be specified");if(this.tags=(this.getAttribute("data-tags")||"").split(","),!this.tags.length)throw new Error("ezsearch-fitment: data-tags must be specified");if(this.elements.parentWidget=document.getElementById(e),!this.elements.parentWidget)throw new Error("ezsearch-fitment: parent widget not found");return this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.unsubscribe&&this.unsubscribe(),this.unsubscribe=this.elements.parentWidget.subscribe(this.onUpdate),!0}unmount(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}onUpdate({selectedItemTitle:e,filteredCollectionHref:i}){const s=this.elements.parentWidget.fits(this.tags);this.setAttribute("data-fitment-status",s);for(let t=0,r=this.elements.itemTitles.length;t<r;t++){const l=this.elements.itemTitles[t],o=typeof l.__ezs_fallback_text>"u"?l.__ezs_fallback_text=l.getAttribute("data-fallback-text"):l.__ezs_fallback_text,a=e||o;l.textContent=a,a?l.setAttribute("title",a):l.removeAttribute("title")}for(let t=0,r=this.elements.filteredHrefs.length;t<r;t++){const l=this.elements.filteredHrefs[t];l.href=i||"#"}}}window.customElements.get("ezsearch-global-v2")||window.customElements.define("ezsearch-global-v2",M),window.customElements.get("ezsearch-fitment-v2")||window.customElements.define("ezsearch-fitment-v2",W),A.EzsearchFitmentV2=W,A.EzsearchGlobalV2=M,Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
