(function(v,C){typeof exports=="object"&&typeof module<"u"?C(exports):typeof define=="function"&&define.amd?define(["exports"],C):(v=typeof globalThis<"u"?globalThis:v||self,C(v.EZSearchV2={}))})(this,function(v){"use strict";var C=Object.defineProperty,G=(i,e,s)=>e in i?C(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,R=(i,e,s)=>(G(i,typeof e!="symbol"?e+"":e,s),s);class $ extends HTMLElement{constructor(){super(),this._connected=!1,this._ac=null,this.is_mounted=!1}async connectedCallback(){if(this._connected=!0,await Promise.resolve(),!this._connected)return;this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=new AbortController;let e=this.mount();e instanceof Promise&&(e=await e),e!==!1&&this._aftermount(),this.is_mounted=!0}mount(){}unmount(){}_aftermount(){this.setAttribute("hydrated","true")}_afterunmount(){this.setAttribute("hydrated","false")}async disconnectedCallback(){this._connected=!1,await Promise.resolve(),!this._connected&&(this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=null,this.unmount(),this._afterunmount(),this.is_mounted=!1)}}const J=i=>Object.prototype.toString.call(i).slice(8,-1),Y=i=>J(i)==="Object";let F="[EZSearch] :: ";function E(...i){return console.log(F,...i)}E.warn=(...i)=>console.warn(F,...i),E.info=(...i)=>console.info(F,...i),E.error=(...i)=>console.error(F,...i);const P={};async function B(i,e){const s=i.replace(/\\\//g,"/");if(P[s])return P[s].then(n=>e(n.clone()));const t=fetch(s);return P[s]=t,t.then(n=>e(n.clone()))}function Q(i){let e=[],s=!1;for(let t=0,n=0,l=0;l<i.length;l++){let r=i[l],a=i[l+1];if(e[t]=e[t]||[],e[t][n]=e[t][n]||"",r=='"'&&s&&a=='"'){e[t][n]+=r,++l;continue}if(r=='"'){s=!s;continue}if(r==","&&!s){++n;continue}if(r=="\r"&&a==`
`&&!s){++t,n=0,++l;continue}if(r==`
`&&!s){++t,n=0;continue}if(r=="\r"&&!s){++t,n=0;continue}e[t][n]+=r}return e}async function Z(i){return await B(i,async e=>{if(!e.ok)throw new Error("ezsearch: Unable to fetch CSV");const s=await e.text();return Q(s)})}function X(i,e="null"){try{return JSON.parse(i||e)}catch{return typeof e=="string"?JSON.parse(e):e}}function ee(i,e){let s=0,t=null;return e.forEach((n,l)=>{l===i&&t==null&&(t=s),s++}),t}function te(i){return i[i.length-1]}function L({tag:i,collectionHandle:e,queryParams:s}){let t=`/collections/${e||"all"}/${i}`;s&&(t+=`?${s}`);let n=`/collections/${e||"all"}?filter.p.tag=${i}`;return s&&(n+=`&${s}`),{legacy:t,new:n}}const b={ATTR:{id:"data-ezs-id",db_url:"data-ezs-db-url",legacy_search:"data-legacy-search",filter:"data-ezs-filter",config_url:"data-ezs-config-url",coll_handle:"data-ezs-collection-handle",reset_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",item_title:"data-ezs-item-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_selection:"data-ezs-clear-selection",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_btn_class:"data-ezs-loading-class",legacy_collections:"data-ezs-legacy-cols"}};function U(i,e,s=0){if(Y(i)){let t=Object.keys(i);t.forEach(n=>{let l=i[n];U(l,e,s+1)}),e(i,t,s)}return Array.isArray(i)&&i.forEach(t=>{U(t,e,s)}),i}function se({data:i,keys:e=[],path:s=[],keysSort:t=[]}){let n={};return e.forEach((l,r)=>{let a=r===e.length-1;i.forEach(o=>{if(!o)return;let c=s.reduce((h,A)=>h[A],o);if(!c)return;let u=c[l];if(typeof u=="number"&&(u=u.toString()),typeof u!="string"||u==="")return;let p=e.slice(0,r).reduce((h,A)=>h[c[A]],n);if(p)if(a){const h=new K(o);p[u]?Array.isArray(p[u])?p[u].push(h):p[u]=[p[u],h]:p[u]=h}else p[u]={}})}),Object.keys(n).length>0?U(n,(l,r,a)=>{if(!l._tag){const o=t[a]?.desc;l._keys_=r.sort((c,u)=>o?u.localeCompare(c):c.localeCompare(u))}}):n}function ie(i,e){if(e<0||e>=i.length)return!1;let s=i.slice(0,e);return Array.isArray(i[0])?s.every(([n,l])=>!!l):s.every(n=>!!n)}function ne({selectedValues:i,index:e,filterTree:s}){let t=ie(i,e);if(!t)return null;if(t){const n=Array.isArray(i[0]);return i.slice(0,e).reduce((r,a)=>{if(r==null)return null;let o=n?a[1]:a;return r[o]},s)}}function le({keys:i,filterTree:e,activeFilters:s}){return i.reduce((t,n)=>{let l=s.get(n);return l&&t?.[l]||null},e)}class K{constructor(e){this.value=e}}const k=i=>`ezs_${i}`,H=i=>`${i}__expiresIn`;function O(i){const e=k(i);return window.localStorage.removeItem(e),window.localStorage.removeItem(H(e)),!0}function V(i){const e=k(i);let s=Date.now();return Number(window.localStorage.getItem(H(e))||"0")<s?(O(e),null):window.localStorage.getItem(e)}function q(i,e,s=60*5){const t=k(i);s=Math.abs(s);let l=Date.now()+s*1e3;return window.localStorage.setItem(t,e),window.localStorage.setItem(H(t),l),!0}const D={},M=[],I=class T extends ${constructor(){if(super(),this.uid=this.id||this.getAttribute(b.ATTR.id),!this.uid)throw new Error(`ezsearch: id must be specified (\`id\` | \`${b.ATTR.id}\`)`);this.elements={form:null,selects:null,toggleOpen:null,submitBtns:null,resetBtns:null,itemTitles:null,filteredHrefs:null},this.options=null,this.singletonData=null,this.state={activeFilters:null,allSelected:!1,selectedItem:null,selectedItemTitle:null,filteredCollectionHref:null},this._handleChange=this._handleChange.bind(this),this._handleChangeFn=this._handleChangeFn.bind(this)}subscribe(e,s=!0){const t=this.singletonData?.subscribers;if(!t)throw new Error("ezsearch: not initialized");return t.push(e),s!==!1&&e(this.state),()=>{const n=this.singletonData?.subscribers;if(!n)throw new Error("ezsearch: not initialized");const l=n.indexOf(e);l>-1&&n.splice(l,1)}}_runSubscribers(){const e=this.singletonData.subscribers;for(let s=0,t=e.length;s<t;s++){const n=e[s];n(this.state)}}async mount(){this.elements.form=this.querySelector("form[data-ezs-form]"),this.elements.selects=Array.from(this.querySelectorAll("select[data-ezs-filter]")),this.elements.toggleOpen=Array.from(this.querySelectorAll("[data-ezs-toggle-open]")),this.elements.submitBtns=Array.from(this.elements.form.querySelectorAll('[type="submit"]')),this.elements.resetBtns=Array.from(this.querySelectorAll('[data-ezs-goto-mode="selection"]')),this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.options=re(this);const{configUrl:e,filterKeys:s,canCache:t,preClearCache:n}=this.options;let{dbUrl:l}=this.options,r=D[this.uid];if(r||(M.push(this.uid),r={subscribers:[],data:null,_loaded:!1},D[this.uid]=r,this.singletonData=r,T.instances.includes(this)||T.instances.push(this)),!r.data){if(!l&&(l=(await B(e,o=>o.json()))?.settings?.form?.db,!l))throw console.log("ezsearch: data",r.data),new Error("ezsearch: unable to fetch db url");this.options.dbUrl=l,r.data=await Z(l).then(a=>ae(a,this.options))}return this.state.activeFilters=new Map(Array.from({length:s.length},(a,o)=>[s[o],!t||n?"":V(s[o])||""])),this._setupListeners(),!0}unmount(){}_updateOptions({selectIndex:e,updateSelectValue:s=!1,forcePending:t=!1,_initial_setup:n=!1,autoSearch:l=this.options.autoSearch}){let r=[...this.state.activeFilters];r.forEach(([a,o],c)=>{const u=ne({selectedValues:r,index:c,filterTree:this.singletonData.data.tree});u?.[o]||this.state.activeFilters.set(a,"");const p=c>e,h=this.elements.selects[c],A=u?._keys_||[],x=Array.isArray(A)&&A.length>0;h.disabled=!x,this.options.canCache&&(o?q(a,o,this.options.cacheSeconds):O(a)),(e===-1||s?!1:p?this.options.resetNextSelectsOnChange?!1:A.length===h.options.length-1&&A.every((d,w)=>d===h.options[w+1].value):!0)||(h.options.length=1,A.forEach((d,w)=>{h.options[w+1]=new Option(d,d)}),h.value=this.state.activeFilters.get(a)||"",requestAnimationFrame(()=>{}))}),this.state.allSelected=[...this.state.activeFilters].every(([,a])=>!!a),this.setAttribute("data-ezs-selected-filters",this.state.allSelected?"all":"partial"),this.state.allSelected||this.setAttribute("data-ezs-state","pending"),(t||e===-1)&&this._afterOptionsUpdate({forcePending:t}),this.state.allSelected&&(this._afterOptionsUpdate(),this.elements.form.dispatchEvent(new Event("submit")),this.options.autoSearch&&this.dispatchEvent(new CustomEvent("ezsearch::_internal_submit",{bubbles:!1,detail:{_initial_setup:n,autoSearch:l}}))),this.singletonData?._loaded&&this.dispatchEvent(new CustomEvent("ezsearch::select_update",{detail:{index:e,select:this.elements.selects[e]},bubbles:!1,cancelable:!1})),n&&!this.singletonData._loaded&&(this.singletonData._loaded=!0,this.dispatchEvent(new CustomEvent("ezsearch::loaded",{bubbles:!1,cancelable:!1})),this._afterOptionsUpdate())}_afterOptionsUpdate({forcePending:e=!1,fromCache:s=!1}={}){const t=e?null:s?X(V("selectedItem"),"null"):le({keys:this.options.filterKeys,activeFilters:this.state.activeFilters,filterTree:this.singletonData.data.tree}),n=t instanceof K?t.value:null,l=n?._path||"",r=n?._tag||"";this.state.selectedItem=n,this.state.selectedItemTitle=n?this.options.filterKeys.map(a=>this.state.activeFilters.get(a)).join(" "):"",this.state.filteredCollectionHref=l,this.setAttribute("data-ezs-state",n?"selected":"pending");for(let a=0,o=this.elements.itemTitles.length;a<o;a++){const c=this.elements.itemTitles[a],u=typeof c.__ezs_fallback_text>"u"?c.__ezs_fallback_text=c.getAttribute("data-fallback-text"):c.__ezs_fallback_text,p=this.state.selectedItemTitle||u;c.textContent=p,p?c.setAttribute("title",p):c.removeAttribute("title")}for(let a=0,o=this.elements.filteredHrefs.length;a<o;a++){const c=this.elements.filteredHrefs[a];if(c instanceof HTMLAnchorElement){const u=c.getAttribute(b.ATTR.coll_handle),p=c.getAttribute("data-ezs-legacy");this.options.legacySearch;let h=u||p!=null?L({tag:r,collectionHandle:u}).legacy:l;c.setAttribute("href",h),c.toggleAttribute("disabled",!h)}}for(let a=0,o=this.elements.resetBtns.length;a<o;a++)this.elements.resetBtns[a].toggleAttribute("disabled",!this.state.allSelected);if(this._runSubscribers(),n?q("selectedItem",JSON.stringify(n)):O("selectedItem"),this.singletonData?._loaded){const a=new CustomEvent("ezsearch::selection_update",{detail:{selected:n||null,href:l,currentlyAppliedTag:this.options.currentlyAppliedTag,selectedItemTitle:this.state.selectedItemTitle},bubbles:!1,cancelable:!1});this.dispatchEvent(a)}}_handleChange(e){const s=e?.isTrusted;let t=e?.target?.__ezs_index;if(typeof t!="number"){E.warn("no `__ezs_index` found");return}const n=this.options.autoSearch;this._handleChangeFn(t,n),s&&T.instances.forEach(l=>{l!=this&&(l.elements.selects[t].value=this.elements.selects[t].value,l._handleChangeFn(t,n))})}_handleChangeFn(e,s){const t=this.options.filterKeys[e],l=this.elements.selects[e].value;l?this.state.activeFilters.set(t,l):this.state.activeFilters.set(t,""),this.options.resetNextSelectsOnChange&&[...this.state.activeFilters].forEach(([r],a)=>{a>e&&this.state.activeFilters.set(r,"")}),this._updateOptions({selectIndex:e,autoSearch:s})}_updateFilterValue(e,s){if(!this.state.activeFilters.has(e))return;typeof s=="string"?s=s.trim():s="";let n=ee(e,this.state.activeFilters);n!=null&&(this.state.activeFilters.set(e,s),this._updateOptions({selectIndex:n,updateSelectValue:!0,forcePending:!0}))}_clearAllCache(){O("selectedItem"),this.options.filterKeys.forEach(e=>O(e))}_setupListeners(){this.setAttribute("aria-expanded","false");for(let t=0,n=this.elements.toggleOpen.length;t<n;t++)this.elements.toggleOpen[t].addEventListener("click",()=>{this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")},{signal:this._ac.signal});const e=this.elements.selects;let s=e.map((t,n)=>{t.__ezs_index=n;let l=t.options[0];return l?(l.value="",l):(l=new Option("All","",!0,!0),l)});for(let t=0,n=e.length;t<n;t++){const l=e[t];l.addEventListener("change",this._handleChange,{signal:this._ac.signal}),l.options.length=1,l.options[0]=s[t]}this.elements.form.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation();const n=t.isTrusted;this.state.allSelected&&T.instances.forEach(l=>{l.state.allSelected&&(n||l!=this)&&l._afterOptionsUpdate()})}),this.addEventListener("ezsearch::_internal_submit",t=>{t.preventDefault();const{_initial_setup:n,autoSearch:l}=t.detail;n||l&&this.state.filteredCollectionHref&&(window.location.href=this.state.filteredCollectionHref)});for(let t=0,n=this.elements.resetBtns.length;t<n;t++){const l=this.elements.resetBtns[t],r=l instanceof HTMLAnchorElement,a=l.getAttribute(b.ATTR.clear_selection)==="true";l.addEventListener("click",o=>{this._resetAllInstances(a,r),l.getAttribute("data-ezs-goto-base-collection")==="true"&&this.options.collectionHandle&&(r&&l.href||(o.preventDefault(),o.stopPropagation(),window.location.href=`/collections/${this.options.collectionHandle}`))})}this._updateOptions({selectIndex:-1,_initial_setup:!0})}_resetAllInstances(e=!1,s=!1){T.instances.forEach(t=>{t._resetSelects(e,s)})}_resetSelects(e=!1,s=!1){const t=this.elements.selects;e&&(this._clearAllCache(),this._updateFilterValue(this.options.filterKeys[0],"")),s||(this._afterOptionsUpdate({forcePending:!0}),t[0].focus())}fits(e){if(!this.singletonData?.data?.tree)return"loading";const s=this.state.selectedItem?._tag;if(!s)return"no-selection";if(typeof e=="string"||Array.isArray(e))return(Array.isArray(e)?e:e.split(",")).includes(s)?"fits":"not-fits";throw new Error("ezsearch: Please pass the `tags` argument (string | string[])")}};R(I,"instancesCache",D),R(I,"widgetIds",M),R(I,"instances",[]);let N=I;function re(i){const e=Array.from(i.querySelectorAll(`select[${b.ATTR.filter}]`)),s=e.reduce((g,_)=>{const m=_.getAttribute(b.ATTR.filter);return m&&g.push(m.trim()),g},[]);if(s.length<1||e.length!==s.length)throw new Error("ezsearch: Filter keys/selects mismatch");const t=e.map(g=>({desc:g.getAttribute(b.ATTR.sort_by)==="desc"})),n=i.getAttribute(b.ATTR.config_url),l=i.getAttribute(b.ATTR.db_url);if(!n&&!l)throw new Error("ezsearch: data-ezs-config-url or data-ezs-db-url must be specified");const r=i.getAttribute(b.ATTR.legacy_search)==="true",a=i.getAttribute(b.ATTR.csv_headers)==="true",o=i.getAttribute(b.ATTR.coll_handle)||"all",c=i.getAttribute(b.ATTR.reset_next_selects_on_change)==="true",u=i.getAttribute(b.ATTR.auto_search)==="true",p=(i.getAttribute(b.ATTR.legacy_collections)?.split(",")||[]).reduce((g,_)=>(_&&(g[_]=!0),g),{});let h=i.getAttribute(b.ATTR.cache_seconds);typeof h=="string"&&(h=Number(h)||300),h=typeof h=="number"?Math.max(Math.trunc(h),0):0;const A=i.getAttribute(b.ATTR.pre_clear_cache)==="true",x=typeof h=="number"&&!Number.isNaN(h)&&h>0;let f=new URLSearchParams(window.location.search);f.delete("filter.p.tag"),f=f.toString(),f[0]=="?"&&(f=f.slice(1));const d=new URL(window.location.href),w=d.pathname.split("/");if(w[1]==="collections"&&!(w[3]=="products"&&w[4])){let g=d.searchParams.get("filter.p.tag");const _=!g&&w[3]&&!w[4];g&&r?window.location.replace(`/collections/${o}/${g}`):_&&!r&&window.location.replace(`/collections/${o}?filter.p.tag=${g}`)}return{filterSelects:e,filterKeys:s,filterKeysSortBy:t,configUrl:n,dbUrl:l,hasCsvHeaders:a,collectionHandle:o,legacySearch:r,cacheSeconds:h,canCache:x,preClearCache:A,resetNextSelectsOnChange:c,autoSearch:u,restQueryParams:f,legacyCols:p,get currentlyAppliedTag(){let g="";const _=window.location.href,m=new URL(_),y=m.pathname.split("/");if(y[1]==="collections"&&!(y[3]=="products"&&y[4]))if(r)y[3]&&(g=y[3]);else{const j=m.searchParams.get("filter.p.tag");j&&(g=j)}return g}}}function ae(i,e){const{hasCsvHeaders:s,filterKeys:t,collectionHandle:n,legacySearch:l,legacyCols:r,filterKeysSortBy:a,restQueryParams:o}=e;(s||t.every((f,d)=>i[0][d]===f))&&(i=i.slice(1));let c=!0,u=t.length,p=t.findIndex(f=>f.toLowerCase()==="year"),h=i;p!==-1&&(h=i.reduce((f,d)=>{const w=d[p];if(!w.includes("-"))return f.push(d),f;let[g,_]=w.split("-").map(m=>Number(m)).reduce((m,y)=>(m.push(Number.isNaN(y)?null:y),m),[]);if(g&&_){for(let m=g;m<=_;m++)f.push(d.map((y,S)=>S===p?m:y));return f}if(!_&&g){const m=g;return f.push(d.map((y,S)=>S===p?m:y)),f}return f},[]));let A=h.map(f=>{if(c&&f.length-1!==u&&(E.error("CSV data and `filterKeys` mismatch",{filterKeys:t,line:f}),c=!1),!c)return[];let d=f[t.length];if(typeof d=="string"){d.startsWith(">>")&&(d=d.slice(2),f[t.length]=d);const z="/collections/all/";if(d.startsWith(z)&&(d=d.slice(z.length)),d.includes("$$$")){const[_]=d.split("$$$");if(_)d=_,f[t.length]=d;else return[]}}return f.reduce((z,g,_)=>{let m=t[_];if(m)z[m]=g;else if(typeof g=="string"){const y=te(g.split("/"));z._tag=y;const S=L({tag:y,collectionHandle:n,queryParams:o});z._path=l?S.legacy:S.new,z._path_new=S.new,z._path_legacy=S.legacy}return z},{})});if(!c)throw new Error("ezsearch: CSV data and `filterKeys` mismatch");return{tree:se({data:A,path:[],keys:t,keysSort:a}),parsedData:A}}class W extends ${constructor(){super(),this.onUpdate=this.onUpdate.bind(this),this.tags=null,this.elements={parentWidget:null,itemTitles:null,filteredHrefs:null,resetBtns:null}}mount(){const e=this.getAttribute("data-ezs-widget-id");if(!e)throw new Error("ezsearch-fitment: data-ezs-widget-id must be specified");if(this.tags=(this.getAttribute("data-tags")||"").split(","),!this.tags.length)throw new Error("ezsearch-fitment: data-tags must be specified");if(this.elements.parentWidget=document.getElementById(e),!this.elements.parentWidget)throw new Error("ezsearch-fitment: parent widget not found");this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.elements.resetBtns=Array.from(this.querySelectorAll('[data-ezs-goto-mode="selection"]')),this.unsubscribe&&this.unsubscribe(),this.unsubscribe=this.elements.parentWidget.subscribe(this.onUpdate);for(let s=0,t=this.elements.resetBtns.length;s<t;s++)this.elements.resetBtns[s].addEventListener("click",()=>{const l=this.elements.parentWidget;l&&l._resetAllInstances(!1,!1)},{signal:this._ac.signal});return!0}unmount(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}onUpdate({selectedItemTitle:e,filteredCollectionHref:s}){const t=this.elements.parentWidget.fits(this.tags);this.setAttribute("data-fitment-status",t);for(let n=0,l=this.elements.itemTitles.length;n<l;n++){const r=this.elements.itemTitles[n],a=typeof r.__ezs_fallback_text>"u"?r.__ezs_fallback_text=r.getAttribute("data-fallback-text"):r.__ezs_fallback_text,o=e||a;r.textContent=o,o?r.setAttribute("title",o):r.removeAttribute("title")}for(let n=0,l=this.elements.filteredHrefs.length;n<l;n++){const r=this.elements.filteredHrefs[n];r.href=s||"#"}}}window.customElements.get("ezsearch-global-v2")||window.customElements.define("ezsearch-global-v2",N),window.customElements.get("ezsearch-fitment-v2")||window.customElements.define("ezsearch-fitment-v2",W),v.EzsearchFitmentV2=W,v.EzsearchGlobalV2=N,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
