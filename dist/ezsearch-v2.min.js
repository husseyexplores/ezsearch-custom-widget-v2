(function(v,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):(v=typeof globalThis<"u"?globalThis:v||self,T(v.EZSearchV2={}))})(this,function(v){"use strict";var T=Object.defineProperty,j=(n,e,t)=>e in n?T(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,I=(n,e,t)=>(j(n,typeof e!="symbol"?e+"":e,t),t),z=(n,e,t)=>new Promise((s,i)=>{var r=a=>{try{o(t.next(a))}catch(d){i(d)}},l=a=>{try{o(t.throw(a))}catch(d){i(d)}},o=a=>a.done?s(a.value):Promise.resolve(a.value).then(r,l);o((t=t.apply(n,e)).next())});class V extends HTMLElement{constructor(){super(),this._connected=!1,this._ac=null,this.is_mounted=!1}connectedCallback(){return z(this,null,function*(){if(this._connected=!0,yield Promise.resolve(),!this._connected)return;this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=new AbortController;let e=this.mount();e instanceof Promise&&(e=yield e),e===!0&&this._aftermount(),this.is_mounted=!0})}mount(){return!0}unmount(){}_aftermount(){this.setAttribute("hydrated","true")}_afterunmount(){this.setAttribute("hydrated","false")}disconnectedCallback(){return z(this,null,function*(){this._connected=!1,yield Promise.resolve(),!this._connected&&(this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=null,this.unmount(),this._afterunmount(),this.is_mounted=!1)})}}const G=n=>Object.prototype.toString.call(n).slice(8,-1),J=n=>G(n)==="Object";let F="[EZSearch] :: ";function C(...n){return console.log(F,...n)}C.warn=(...n)=>console.warn(F,...n),C.info=(...n)=>console.info(F,...n),C.error=(...n)=>console.error(F,...n);const k={};function U(n,e){return z(this,null,function*(){const t=n.replace(/\\\//g,"/");if(k[t])return k[t].then(i=>e(i.clone()));const s=fetch(t);return k[t]=s,s.then(i=>e(i.clone()))})}function Y(n){let e=[],t=!1;for(let s=0,i=0,r=0;r<n.length;r++){let l=n[r],o=n[r+1];if(e[s]=e[s]||[],e[s][i]=e[s][i]||"",l=='"'&&t&&o=='"'){e[s][i]+=l,++r;continue}if(l=='"'){t=!t;continue}if(l==","&&!t){++i;continue}if(l=="\r"&&o==`
`&&!t){++s,i=0,++r;continue}if(l==`
`&&!t){++s,i=0;continue}if(l=="\r"&&!t){++s,i=0;continue}e[s][i]+=l}return e}function Z(n){return z(this,null,function*(){return yield U(n,e=>z(this,null,function*(){if(!e.ok)throw new Error("ezsearch: Unable to fetch CSV");const t=yield e.text();return Y(t)}))})}function X(n,e="null"){try{return JSON.parse(n||e)}catch{return typeof e=="string"?JSON.parse(e):e}}function Q(n,e){let t=0,s=null;return e.forEach((i,r)=>{r===n&&s==null&&(s=t),t++}),s}function ee(n){return n[n.length-1]}const m={ATTR:{id:"data-ezs-id",legacy_search:"data-legacy-search",filter:"data-ezs-filter",config_url:"data-ezs-config-url",coll_handle:"data-ezs-collection-handle",reset_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",item_title:"data-ezs-item-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_selection:"data-ezs-clear-selection",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function P(n,e,t=0){if(J(n)){let s=Object.keys(n);s.forEach(i=>{let r=n[i];P(r,e,t+1)}),e(n,s,t)}return Array.isArray(n)&&n.forEach(s=>{P(s,e,t)}),n}function te({data:n,keys:e=[],path:t=[],keysSort:s=[]}){let i={};return e.forEach((r,l)=>{let o=l===e.length-1;n.forEach(a=>{if(!a)return;let d=t.reduce((g,w)=>g[w],a);if(!d)return;let c=d[r];if(typeof c=="number"&&(c=c.toString()),typeof c!="string"||c==="")return;let h=e.slice(0,l).reduce((g,w)=>g[d[w]],i);if(h)if(o){const g=new D(a);h[c]?Array.isArray(h[c])?h[c].push(g):h[c]=[h[c],g]:h[c]=g}else h[c]={}})}),Object.keys(i).length>0?P(i,(r,l,o)=>{var a;if(!r._tag){const d=(a=s[o])==null?void 0:a.desc;r._keys_=l.sort((c,h)=>d?h.localeCompare(c):c.localeCompare(h))}}):i}function se(n,e){if(e<0||e>=n.length)return!1;let t=n.slice(0,e);return Array.isArray(n[0])?t.every(([i,r])=>!!r):t.every(i=>!!i)}function ie({selectedValues:n,index:e,filterTree:t}){let s=se(n,e);if(!s)return null;if(s){const i=Array.isArray(n[0]);return n.slice(0,e).reduce((l,o)=>{if(l==null)return null;let a=i?o[1]:o;return l[a]},t)}}function ne({keys:n,filterTree:e,activeFilters:t}){return n.reduce((s,i)=>{let r=t.get(i);return r&&s?.[r]||null},e)}class D{constructor(e){this.value=e}}const R=n=>`ezs_${n}`,B=n=>`${n}__expiresIn`;function O(n){const e=R(n);return window.localStorage.removeItem(e),window.localStorage.removeItem(B(e)),!0}function L(n){const e=R(n);let t=Date.now();return Number(window.localStorage.getItem(B(e))||"0")<t?(O(e),null):window.localStorage.getItem(e)}function $(n,e,t=60*5){const s=R(n);t=Math.abs(t);let r=Date.now()+t*1e3;return window.localStorage.setItem(s,e),window.localStorage.setItem(B(s),r),!0}const q=window.EzsearchGlobalV2Options,H={},N=[],x=class E extends V{constructor(){if(super(),this.uid=this.id||this.getAttribute(m.ATTR.id),!this.uid)throw new Error(`ezsearch: id must be specified (\`id\` | \`${m.ATTR.id}\`)`);this.elements={form:null,selects:null,toggleOpen:null,submitBtns:null,resetBtns:null,itemTitles:null,filteredHrefs:null},this.options=null,this.singletonData=null,this.state={activeFilters:null,allSelected:!1,selectedItem:null,selectedItemTitle:null,filteredCollectionHref:null},this._handleChange=this._handleChange.bind(this),this._handleChangeFn=this._handleChangeFn.bind(this)}subscribe(e,t=!0){var s;const i=(s=this.singletonData)==null?void 0:s.subscribers;if(!i)throw new Error("ezsearch: not initialized");return i.push(e),t!==!1&&e(this.state),()=>{var r;const l=(r=this.singletonData)==null?void 0:r.subscribers;if(!l)throw new Error("ezsearch: not initialized");const o=l.indexOf(e);o>-1&&l.splice(o,1)}}_runSubscribers(){const e=this.singletonData.subscribers;for(let t=0,s=e.length;t<s;t++){const i=e[t];i(this.state)}}mount(){return z(this,null,function*(){var e,t;this.elements.form=this.querySelector("form[data-ezs-form]"),this.elements.selects=Array.from(this.querySelectorAll("select[data-ezs-filter]")),this.elements.toggleOpen=Array.from(this.querySelectorAll("[data-ezs-toggle-open]")),this.elements.submitBtns=Array.from(this.elements.form.querySelectorAll('[type="submit"]')),this.elements.resetBtns=Array.from(this.querySelectorAll('[data-ezs-goto-mode="selection"]')),this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.options=le(this);const{configUrl:s,filterKeys:i,canCache:r,preClearCache:l}=this.options;let o=H[this.uid];if(o||(N.push(this.uid),o={subscribers:[],data:null},H[this.uid]=o,this.singletonData=o,E.instances.includes(this)||E.instances.push(this)),!o.data){const a=yield U(s,c=>c.json()),d=(t=(e=a?.settings)==null?void 0:e.form)==null?void 0:t.db;if(!d)throw console.log("ezsearch: data",o.data),new Error("ezsearch: unable to fetch db url");o.data=yield Z(d).then(c=>ae(c,this.options))}return this.state.activeFilters=new Map(Array.from({length:i.length},(a,d)=>[i[d],!r||l?"":L(i[d])||""])),this._setupListeners(),!0})}unmount(){}_updateOptions({selectIndex:e,updateSelectValue:t=!1,forcePending:s=!1}){let i=[...this.state.activeFilters];i.forEach(([r,l],o)=>{const a=ie({selectedValues:i,index:o,filterTree:this.singletonData.data.tree});a?.[l]||this.state.activeFilters.set(r,"");const d=o>e,c=this.elements.selects[o],h=a?._keys_||[],g=Array.isArray(h)&&h.length>0;c.disabled=!g,this.options.canCache&&(l?$(r,l,this.options.cacheSeconds):O(r)),(e===-1||t?!1:d?this.options.resetNextSelectsOnChange?!1:h.length===c.options.length-1&&h.every((u,f)=>u===c.options[f+1].value):!0)||(c.options.length=1,requestAnimationFrame(()=>{h.forEach((u,f)=>{c.options[f+1]=new Option(u,u)}),c.value=this.state.activeFilters.get(r)||""}))}),this.state.allSelected=[...this.state.activeFilters].every(([,r])=>!!r),this.setAttribute("data-ezs-selected-filters",this.state.allSelected?"all":"partial"),this.state.allSelected||this.setAttribute("data-ezs-state","pending"),(s||e===-1)&&this._afterOptionsUpdate({forcePending:s}),this.state.allSelected&&this.options.autoSearch&&this.elements.form.dispatchEvent(new Event("submit")),this.dispatchEvent(new CustomEvent("ezsearch::selection_update",{detail:{index:e,select:this.elements.selects[e]},bubbles:!1,cancelable:!1}))}_afterOptionsUpdate({forcePending:e=!1,fromCache:t=!1}={}){const s=e?null:t?X(L("selectedItem"),"null"):ne({keys:this.options.filterKeys,activeFilters:this.state.activeFilters,filterTree:this.singletonData.data.tree}),i=s instanceof D?s.value:null,r=i?._path||"";this.state.selectedItem=i,this.state.selectedItemTitle=i?this.options.filterKeys.map(l=>this.state.activeFilters.get(l)).join(" "):"",this.state.filteredCollectionHref=r,this.setAttribute("data-ezs-state",i?"selected":"pending"),i&&this.dispatchEvent(new CustomEvent("ezsearch::selection_complete",{detail:{selected:i},bubbles:!1,cancelable:!1}));for(let l=0,o=this.elements.itemTitles.length;l<o;l++){const a=this.elements.itemTitles[l],d=typeof a.__ezs_fallback_text>"u"?a.__ezs_fallback_text=a.getAttribute("data-fallback-text"):a.__ezs_fallback_text,c=this.state.selectedItemTitle||d;a.textContent=c,c?a.setAttribute("title",c):a.removeAttribute("title")}for(let l=0,o=this.elements.filteredHrefs.length;l<o;l++){const a=this.elements.filteredHrefs[l];a instanceof HTMLAnchorElement&&(a.setAttribute("href",r),a.toggleAttribute("disabled",!r))}this._runSubscribers(),i?$("selectedItem",JSON.stringify(i)):O("selectedItem")}_handleChange(e){var t;const s=e?.isTrusted;let i=(t=e?.target)==null?void 0:t.__ezs_index;if(typeof i!="number"){C.warn("no `__ezs_index` found");return}this._handleChangeFn(i),s&&E.instances.forEach(r=>{r!=this&&(r.elements.selects[i].value=this.elements.selects[i].value,r._handleChangeFn(i))})}_handleChangeFn(e){const t=this.options.filterKeys[e],i=this.elements.selects[e].value;i?this.state.activeFilters.set(t,i):this.state.activeFilters.set(t,""),this.options.resetNextSelectsOnChange&&[...this.state.activeFilters].forEach(([r],l)=>{l>e&&this.state.activeFilters.set(r,"")}),this._updateOptions({selectIndex:e})}_updateFilterValue(e,t){if(!this.state.activeFilters.has(e))return;typeof t=="string"?t=t.trim():t="";let i=Q(e,this.state.activeFilters);i!=null&&(this.state.activeFilters.set(e,t),this._updateOptions({selectIndex:i,updateSelectValue:!0,forcePending:!0}))}_clearAllCache(){O("selectedItem"),this.options.filterKeys.forEach(e=>O(e))}_setupListeners(){this.setAttribute("aria-expanded","false");for(let s=0,i=this.elements.toggleOpen.length;s<i;s++)this.elements.toggleOpen[s].addEventListener("click",()=>{this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")},{signal:this._ac.signal});const e=this.elements.selects;let t=e.map((s,i)=>{s.__ezs_index=i;let r=s.options[0];return r?(r.value="",r):(r=new Option("All","",!0,!0),r)});for(let s=0,i=e.length;s<i;s++){const r=e[s];r.addEventListener("change",this._handleChange,{signal:this._ac.signal}),r.options.length=1,r.options[0]=t[s]}this.elements.form.addEventListener("submit",s=>{s.preventDefault(),s.stopPropagation(),this.state.allSelected&&(this._afterOptionsUpdate(),E.instances.forEach(i=>{i!=this&&i.state.allSelected&&i._afterOptionsUpdate()}))});for(let s=0,i=this.elements.resetBtns.length;s<i;s++){const r=this.elements.resetBtns[s],l=r instanceof HTMLAnchorElement,o=r.getAttribute(m.ATTR.clear_selection)==="true";r.addEventListener("click",()=>{this._resetAllInstances(o,l)})}this._updateOptions({selectIndex:-1})}_resetAllInstances(e=!1,t=!1){E.instances.forEach(s=>{s._resetSelects(e,t)})}_resetSelects(e=!1,t=!1){const s=this.elements.selects;e&&(this._clearAllCache(),this._updateFilterValue(this.options.filterKeys[0],"")),t||(this._afterOptionsUpdate({forcePending:!0}),s[0].focus())}fits(e){var t,s,i;if(!((s=(t=this.singletonData)==null?void 0:t.data)!=null&&s.tree))return"loading";const r=(i=this.state.selectedItem)==null?void 0:i._tag;if(!r)return"no-selection";if(typeof e=="string"||Array.isArray(e))return(Array.isArray(e)?e:e.split(",")).includes(r)?"fits":"not-fits";throw new Error("ezsearch: Please pass the `tags` argument (string | string[])")}};I(x,"instancesCache",H),I(x,"widgetIds",N),I(x,"instances",[]);let M=x;function re({tag:n,collectionHandle:e,legacySearch:t}){return t?`/collections/${e||"all"}/${n}`:`/collections/${e||"all"}?filter.p.tag=${n}`}function le(n){const e=Array.from(n.querySelectorAll(`select[${m.ATTR.filter}]`)),t=e.reduce((u,f)=>{const S=f.getAttribute(m.ATTR.filter);return S&&u.push(S.trim()),u},[]);if(t.length<1||e.length!==t.length)throw new Error("ezsearch: Filter keys/selects mismatch");const s=e.map(u=>({desc:u.getAttribute(m.ATTR.sort_by)==="desc"})),i=n.getAttribute(m.ATTR.config_url);if(!i)throw new Error("ezsearch: data-ezs-config-url must be specified");const r=n.getAttribute(m.ATTR.legacy_search)==="true",l=n.getAttribute(m.ATTR.csv_headers)==="true",o=n.getAttribute(m.ATTR.coll_handle)||"all",a=n.getAttribute(m.ATTR.reset_next_selects_on_change)==="true",d=n.getAttribute(m.ATTR.auto_search)==="true",c=q?.filteredProductPathname||re;let h=n.getAttribute(m.ATTR.cache_seconds);typeof h=="string"&&(h=Number(h)||300),h=typeof h=="number"?Math.max(Math.trunc(h),0):0;const g=n.getAttribute(m.ATTR.pre_clear_cache)==="true",w=typeof h=="number"&&!Number.isNaN(h)&&h>0;return{filterSelects:e,filterKeys:t,filterKeysSortBy:s,configUrl:i,hasCsvHeaders:l,collectionHandle:o,createPathname:c,legacySearch:r,cacheSeconds:h,canCache:w,preClearCache:g,resetNextSelectsOnChange:a,autoSearch:d}}function ae(n,e){const{hasCsvHeaders:t,filterKeys:s,collectionHandle:i,createPathname:r,legacySearch:l,filterKeysSortBy:o}=e;(t||s.every((u,f)=>n[0][f]===u))&&(n=n.slice(1));let a=!0,d=s.length,c=s.findIndex(u=>u.toLowerCase()==="year"),h=n;c!==-1&&(h=n.reduce((u,f)=>{const S=f[c];if(!S.includes("-"))return u.push(f),u;let[_,A]=S.split("-").map(p=>Number(p)).reduce((p,b)=>(p.push(Number.isNaN(b)?null:b),p),[]);if(_&&A){for(let p=_;p<=A;p++)u.push(f.map((b,K)=>K===c?p:b));return u}if(!A&&_){const p=_;return u.push(f.map((b,K)=>K===c?p:b)),u}return u},[]));let g=h.map(u=>{if(a&&u.length-1!==d&&(C.error("CSV data and `filterKeys` mismatch",{filterKeys:s,line:u}),a=!1),!a)return[];let f=u[s.length];if(typeof f=="string"){f.startsWith(">>")&&(f=f.slice(2),u[s.length]=f);const y="/collections/all/";if(f.startsWith(y)&&(f=f.slice(y.length)),f.includes("$$$")){const[A]=f.split("$$$");if(A)f=A,u[s.length]=f;else return[]}}return u.reduce((y,_,A)=>{let p=s[A];if(p)y[p]=_;else if(typeof _=="string"){const b=ee(_.split("/"));y._tag=b,y._path=r({tag:b,collectionHandle:i,legacySearch:l})}return y},{})});if(!a)throw new Error("ezsearch: CSV data and `filterKeys` mismatch");return{tree:te({data:g,path:[],keys:s,keysSort:o}),parsedData:g}}class W extends V{constructor(){super(),this.onUpdate=this.onUpdate.bind(this),this.tags=null,this.elements={parentWidget:null,itemTitles:null,filteredHrefs:null,resetBtns:null}}mount(){const e=this.getAttribute("data-ezs-widget-id");if(!e)throw new Error("ezsearch-fitment: data-ezs-widget-id must be specified");if(this.tags=(this.getAttribute("data-tags")||"").split(","),!this.tags.length)throw new Error("ezsearch-fitment: data-tags must be specified");if(this.elements.parentWidget=document.getElementById(e),!this.elements.parentWidget)throw new Error("ezsearch-fitment: parent widget not found");this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.elements.resetBtns=Array.from(this.querySelectorAll('[data-ezs-goto-mode="selection"]')),this.unsubscribe&&this.unsubscribe(),this.unsubscribe=this.elements.parentWidget.subscribe(this.onUpdate);for(let t=0,s=this.elements.resetBtns.length;t<s;t++)this.elements.resetBtns[t].addEventListener("click",()=>{const r=this.elements.parentWidget;r&&r._resetAllInstances(!1,!1)},{signal:this._ac.signal});return!0}unmount(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}onUpdate({selectedItemTitle:e,filteredCollectionHref:t}){const s=this.elements.parentWidget.fits(this.tags);this.setAttribute("data-fitment-status",s);for(let i=0,r=this.elements.itemTitles.length;i<r;i++){const l=this.elements.itemTitles[i],o=typeof l.__ezs_fallback_text>"u"?l.__ezs_fallback_text=l.getAttribute("data-fallback-text"):l.__ezs_fallback_text,a=e||o;l.textContent=a,a?l.setAttribute("title",a):l.removeAttribute("title")}for(let i=0,r=this.elements.filteredHrefs.length;i<r;i++){const l=this.elements.filteredHrefs[i];l.href=t||"#"}}}window.customElements.get("ezsearch-global-v2")||window.customElements.define("ezsearch-global-v2",M),window.customElements.get("ezsearch-fitment-v2")||window.customElements.define("ezsearch-fitment-v2",W),v.EzsearchFitmentV2=W,v.EzsearchGlobalV2=M,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
