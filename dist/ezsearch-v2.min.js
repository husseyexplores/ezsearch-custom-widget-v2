(function(A,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):(A=typeof globalThis<"u"?globalThis:A||self,T(A.EZSearchV2={}))})(this,function(A){"use strict";var T=Object.defineProperty,j=(n,e,s)=>e in n?T(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s,I=(n,e,s)=>(j(n,typeof e!="symbol"?e+"":e,s),s),z=(n,e,s)=>new Promise((t,i)=>{var r=a=>{try{o(s.next(a))}catch(d){i(d)}},l=a=>{try{o(s.throw(a))}catch(d){i(d)}},o=a=>a.done?t(a.value):Promise.resolve(a.value).then(r,l);o((s=s.apply(n,e)).next())});class U extends HTMLElement{constructor(){super(),this._connected=!1,this._ac=null,this.is_mounted=!1}connectedCallback(){return z(this,null,function*(){if(this._connected=!0,yield Promise.resolve(),!this._connected)return;this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=new AbortController;let e=this.mount();e instanceof Promise&&(e=yield e),e===!0&&this._aftermount(),this.is_mounted=!0})}mount(){return!0}unmount(){}_aftermount(){this.setAttribute("hydrated","true")}_afterunmount(){this.setAttribute("hydrated","false")}disconnectedCallback(){return z(this,null,function*(){this._connected=!1,yield Promise.resolve(),!this._connected&&(this._ac&&!this._ac.signal.aborted&&this._ac.abort(),this._ac=null,this.unmount(),this._afterunmount(),this.is_mounted=!1)})}}const G=n=>Object.prototype.toString.call(n).slice(8,-1),J=n=>G(n)==="Object";let F="[EZSearch] :: ";function C(...n){return console.log(F,...n)}C.warn=(...n)=>console.warn(F,...n),C.info=(...n)=>console.info(F,...n),C.error=(...n)=>console.error(F,...n);const k={};function D(n,e){return z(this,null,function*(){const s=n.replace(/\\\//g,"/");if(k[s])return k[s];const t=yield fetch(s).then(e);return k[s]=t,t})}function Y(n){let e=[],s=!1;for(let t=0,i=0,r=0;r<n.length;r++){let l=n[r],o=n[r+1];if(e[t]=e[t]||[],e[t][i]=e[t][i]||"",l=='"'&&s&&o=='"'){e[t][i]+=l,++r;continue}if(l=='"'){s=!s;continue}if(l==","&&!s){++i;continue}if(l=="\r"&&o==`
`&&!s){++t,i=0,++r;continue}if(l==`
`&&!s){++t,i=0;continue}if(l=="\r"&&!s){++t,i=0;continue}e[t][i]+=l}return e}function Z(n){return z(this,null,function*(){return yield D(n,e=>z(this,null,function*(){if(!e.ok)throw new Error("ezsearch: Unable to fetch CSV");const s=yield e.text();return Y(s)}))})}function X(n,e="null"){try{return JSON.parse(n||e)}catch{return typeof e=="string"?JSON.parse(e):e}}function Q(n,e){let s=0,t=null;return e.forEach((i,r)=>{r===n&&t==null&&(t=s),s++}),t}function ee(n){return n[n.length-1]}const m={ATTR:{id:"data-ezs-id",legacy_search:"data-legacy-search",filter:"data-ezs-filter",config_url:"data-ezs-config-url",coll_handle:"data-ezs-collection-handle",reset_next_selects_on_change:"data-ezs-reset-next-selects-on-change",auto_search:"data-ezs-autosearch",csv_headers:"data-ezs-has-csv-headers",filtered_link:"data-ezs-filtered-link",item_title:"data-ezs-item-title",filter_trigger_verify:"data-ezs-trigger-verify",goto_pending:"data-ezs-goto-pending",goto_base_collection:"data-ezs-goto-base-collection",pre_clear_cache:"data-ezs-clear-cache",clear_selection:"data-ezs-clear-selection",cache_seconds:"data-ezs-cache-seconds",prod_tags:"data-ezs-product-tags",fitment_widget:"data-ezs-fitment",sort_by:"data-ezs-sort",toggle_open:"data-ezs-toggle-open",loading_on_click:"data-ezs-load-on-click",loading_btn_class:"data-ezs-loading-class"}};function P(n,e,s=0){if(J(n)){let t=Object.keys(n);t.forEach(i=>{let r=n[i];P(r,e,s+1)}),e(n,t,s)}return Array.isArray(n)&&n.forEach(t=>{P(t,e,s)}),n}function te({data:n,keys:e=[],path:s=[],keysSort:t=[]}){let i={};return e.forEach((r,l)=>{let o=l===e.length-1;n.forEach(a=>{if(!a)return;let d=s.reduce((g,w)=>g[w],a);if(!d)return;let c=d[r];if(typeof c=="number"&&(c=c.toString()),typeof c!="string"||c==="")return;let u=e.slice(0,l).reduce((g,w)=>g[d[w]],i);if(u)if(o){const g=new $(a);u[c]?Array.isArray(u[c])?u[c].push(g):u[c]=[u[c],g]:u[c]=g}else u[c]={}})}),Object.keys(i).length>0?P(i,(r,l,o)=>{var a;if(!r._tag){const d=(a=t[o])==null?void 0:a.desc;r._keys_=l.sort((c,u)=>d?u.localeCompare(c):c.localeCompare(u))}}):i}function se(n,e){if(e<0||e>=n.length)return!1;let s=n.slice(0,e);return Array.isArray(n[0])?s.every(([i,r])=>!!r):s.every(i=>!!i)}function ie({selectedValues:n,index:e,filterTree:s}){let t=se(n,e);if(!t)return null;if(t){const i=Array.isArray(n[0]);return n.slice(0,e).reduce((l,o)=>{if(l==null)return null;let a=i?o[1]:o;return l[a]},s)}}function ne({keys:n,filterTree:e,activeFilters:s}){return n.reduce((t,i)=>{let r=s.get(i);return r&&t?.[r]||null},e)}class ${constructor(e){this.value=e}}const R=n=>`ezs_${n}`,H=n=>`${n}__expiresIn`;function O(n){const e=R(n);return window.localStorage.removeItem(e),window.localStorage.removeItem(H(e)),!0}function L(n){const e=R(n);let s=Date.now();return Number(window.localStorage.getItem(H(e))||"0")<s?(O(e),null):window.localStorage.getItem(e)}function q(n,e,s=60*5){const t=R(n);s=Math.abs(s);let r=Date.now()+s*1e3;return window.localStorage.setItem(t,e),window.localStorage.setItem(H(t),r),!0}const B=window.EzsearchGlobalV2Options,K={},N=[],x=class E extends U{constructor(){if(super(),this.uid=this.id||this.getAttribute(m.ATTR.id),!this.uid)throw new Error(`ezsearch: id must be specified (\`id\` | \`${m.ATTR.id}\`)`);this.elements={form:null,selects:null,toggleOpen:null,submitBtns:null,resetBtns:null,itemTitles:null,filteredHrefs:null},this.options=null,this.singletonData=null,this.state={activeFilters:null,allSelected:!1,selectedItem:null,selectedItemTitle:null,filteredCollectionHref:null},this._handleChange=this._handleChange.bind(this),this._handleChangeFn=this._handleChangeFn.bind(this)}subscribe(e,s=!0){var t;const i=(t=this.singletonData)==null?void 0:t.subscribers;if(!i)throw new Error("ezsearch: not initialized");return i.push(e),s!==!1&&e(this.state),()=>{var r;const l=(r=this.singletonData)==null?void 0:r.subscribers;if(!l)throw new Error("ezsearch: not initialized");const o=l.indexOf(e);o>-1&&l.splice(o,1)}}_runSubscribers(){const e=this.singletonData.subscribers;for(let s=0,t=e.length;s<t;s++){const i=e[s];i(this.state)}}mount(){return z(this,null,function*(){var e,s;this.elements.form=this.querySelector("form[data-ezs-form]"),this.elements.selects=Array.from(this.querySelectorAll("select[data-ezs-filter]")),this.elements.toggleOpen=Array.from(this.querySelectorAll("[data-ezs-toggle-open]")),this.elements.submitBtns=Array.from(this.elements.form.querySelectorAll('[type="submit"]')),this.elements.resetBtns=Array.from(this.querySelectorAll('[data-ezs-goto-mode="selection"]')),this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.options=le(this);const{configUrl:t,filterKeys:i,canCache:r,preClearCache:l}=this.options;let o=K[this.uid];if(o||(N.push(this.uid),o={subscribers:[],data:null},K[this.uid]=o,this.singletonData=o,E.instances.includes(this)||E.instances.push(this)),!o.data){const a=yield D(t,c=>c.json()),d=(s=(e=a?.settings)==null?void 0:e.form)==null?void 0:s.db;if(!d)throw console.log("ezsearch: data",o.data),new Error("ezsearch: unable to fetch db url");o.data=yield Z(d).then(c=>ae(c,this.options))}return this.state.activeFilters=new Map(Array.from({length:i.length},(a,d)=>[i[d],!r||l?"":L(i[d])||""])),this._setupListeners(),!0})}unmount(){}_updateOptions({selectIndex:e,updateSelectValue:s=!1,forcePending:t=!1}){let i=[...this.state.activeFilters];i.forEach(([r,l],o)=>{const a=ie({selectedValues:i,index:o,filterTree:this.singletonData.data.tree});a?.[l]||this.state.activeFilters.set(r,"");const d=o>e,c=this.elements.selects[o],u=a?._keys_||[],g=Array.isArray(u)&&u.length>0;c.disabled=!g,this.options.canCache&&(l?q(r,l,this.options.cacheSeconds):O(r)),(e===-1||s?!1:d?this.options.resetNextSelectsOnChange?!1:u.length===c.options.length-1&&u.every((h,f)=>h===c.options[f+1].value):!0)||(c.options.length=1,requestAnimationFrame(()=>{u.forEach((h,f)=>{c.options[f+1]=new Option(h,h)}),c.value=this.state.activeFilters.get(r)||""}))}),this.state.allSelected=[...this.state.activeFilters].every(([,r])=>!!r),this.setAttribute("data-ezs-selected-filters",this.state.allSelected?"all":"partial"),this.state.allSelected||this.setAttribute("data-ezs-state","pending"),(t||e===-1)&&this._afterOptionsUpdate({forcePending:t}),this.state.allSelected&&this.options.autoSearch&&this.elements.form.dispatchEvent(new Event("submit")),this.dispatchEvent(new CustomEvent("ezsearch::selection_update",{detail:{index:e,select:this.elements.selects[e]},bubbles:!1,cancelable:!1}))}_afterOptionsUpdate({forcePending:e=!1,fromCache:s=!1}={}){const t=e?null:s?X(L("selectedItem"),"null"):ne({keys:this.options.filterKeys,activeFilters:this.state.activeFilters,filterTree:this.singletonData.data.tree}),i=t instanceof $?t.value:null,r=i?._path||"";this.state.selectedItem=i,this.state.selectedItemTitle=i?this.options.filterKeys.map(l=>this.state.activeFilters.get(l)).join(" "):"",this.state.filteredCollectionHref=r,this.setAttribute("data-ezs-state",i?"selected":"pending"),i&&this.dispatchEvent(new CustomEvent("ezsearch::selection_complete",{detail:{selected:i},bubbles:!1,cancelable:!1}));for(let l=0,o=this.elements.itemTitles.length;l<o;l++){const a=this.elements.itemTitles[l],d=typeof a.__ezs_fallback_text>"u"?a.__ezs_fallback_text=a.getAttribute("data-fallback-text"):a.__ezs_fallback_text,c=this.state.selectedItemTitle||d;a.textContent=c,c?a.setAttribute("title",c):a.removeAttribute("title")}for(let l=0,o=this.elements.filteredHrefs.length;l<o;l++){const a=this.elements.filteredHrefs[l];a instanceof HTMLAnchorElement&&(a.setAttribute("href",r),a.toggleAttribute("disabled",!r))}this._runSubscribers(),i?q("selectedItem",JSON.stringify(i)):O("selectedItem")}_handleChange(e){var s;const t=e?.isTrusted;let i=(s=e?.target)==null?void 0:s.__ezs_index;if(typeof i!="number"){C.warn("no `__ezs_index` found");return}this._handleChangeFn(i),t&&E.instances.forEach(r=>{r!=this&&(r.elements.selects[i].value=this.elements.selects[i].value,r._handleChangeFn(i))})}_handleChangeFn(e){const s=this.options.filterKeys[e],i=this.elements.selects[e].value;i?this.state.activeFilters.set(s,i):this.state.activeFilters.set(s,""),this.options.resetNextSelectsOnChange&&[...this.state.activeFilters].forEach(([r],l)=>{l>e&&this.state.activeFilters.set(r,"")}),this._updateOptions({selectIndex:e})}_updateFilterValue(e,s){if(!this.state.activeFilters.has(e))return;typeof s=="string"?s=s.trim():s="";let i=Q(e,this.state.activeFilters);i!=null&&(this.state.activeFilters.set(e,s),this._updateOptions({selectIndex:i,updateSelectValue:!0,forcePending:!0}))}_clearAllCache(){O("selectedItem"),this.options.filterKeys.forEach(e=>O(e))}_setupListeners(){this.setAttribute("aria-expanded","false");for(let t=0,i=this.elements.toggleOpen.length;t<i;t++)this.elements.toggleOpen[t].addEventListener("click",()=>{this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")},{signal:this._ac.signal});const e=this.elements.selects;let s=e.map((t,i)=>{t.__ezs_index=i;let r=t.options[0];return r?(r.value="",r):(r=new Option("All","",!0,!0),r)});for(let t=0,i=e.length;t<i;t++){const r=e[t];r.addEventListener("change",this._handleChange,{signal:this._ac.signal}),r.options.length=1,r.options[0]=s[t]}this.elements.form.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),this.state.allSelected&&(this._afterOptionsUpdate(),E.instances.forEach(i=>{i!=this&&i.state.allSelected&&i._afterOptionsUpdate()}))});for(let t=0,i=this.elements.resetBtns.length;t<i;t++){const r=this.elements.resetBtns[t],l=r instanceof HTMLAnchorElement,o=r.getAttribute(m.ATTR.clear_selection)==="true";r.addEventListener("click",()=>{this._resetSelects(o,l),E.instances.forEach(a=>{a!=this&&a._resetSelects(o,l)})})}this._updateOptions({selectIndex:-1})}_resetSelects(e=!1,s=!1){const t=this.elements.selects;e&&(this._clearAllCache(),this._updateFilterValue(this.options.filterKeys[0],"")),s||(this._afterOptionsUpdate({forcePending:!0}),t[0].focus())}fits(e){var s,t,i;if(!((t=(s=this.singletonData)==null?void 0:s.data)!=null&&t.tree))return"loading";const r=(i=this.state.selectedItem)==null?void 0:i._tag;if(!r)return"no-selection";if(typeof e=="string"||Array.isArray(e))return(Array.isArray(e)?e:e.split(",")).includes(r)?"fits":"not-fits";throw new Error("ezsearch: Please pass the `tags` argument (string | string[])")}};I(x,"instancesCache",K),I(x,"widgetIds",N),I(x,"instances",[]);let M=x;function re({tag:n,collectionHandle:e,legacySearch:s}){return s?`/collections/${e||"all"}/${n}`:`/collections/${e||"all"}?filter.p.tag=${n}`}function le(n){const e=Array.from(n.querySelectorAll(`select[${m.ATTR.filter}]`)),s=e.reduce((h,f)=>{const S=f.getAttribute(m.ATTR.filter);return S&&h.push(S.trim()),h},[]);if(s.length<1||e.length!==s.length)throw new Error("ezsearch: Filter keys/selects mismatch");const t=e.map(h=>({desc:h.getAttribute(m.ATTR.sort_by)==="desc"})),i=n.getAttribute(m.ATTR.config_url);if(!i)throw new Error("ezsearch: data-ezs-config-url must be specified");const r=n.getAttribute(m.ATTR.legacy_search)==="true",l=n.getAttribute(m.ATTR.csv_headers)==="true",o=n.getAttribute(m.ATTR.coll_handle)||"all",a=n.getAttribute(m.ATTR.reset_next_selects_on_change)==="true",d=n.getAttribute(m.ATTR.auto_search)==="true",c=B?.filteredProductPathname||re;let u=n.getAttribute(m.ATTR.cache_seconds);typeof u=="string"&&(u=Number(u)||300),u=typeof u=="number"?Math.max(Math.trunc(u),0):0;const g=n.getAttribute(m.ATTR.pre_clear_cache)==="true",w=typeof u=="number"&&!Number.isNaN(u)&&u>0;return{filterSelects:e,filterKeys:s,filterKeysSortBy:t,configUrl:i,hasCsvHeaders:l,collectionHandle:o,createPathname:c,legacySearch:r,cacheSeconds:u,canCache:w,preClearCache:g,resetNextSelectsOnChange:a,autoSearch:d}}function ae(n,e){const{hasCsvHeaders:s,filterKeys:t,collectionHandle:i,createPathname:r,legacySearch:l,filterKeysSortBy:o}=e;(s||t.every((h,f)=>n[0][f]===h))&&(n=n.slice(1));let a=!0,d=t.length,c=t.findIndex(h=>h.toLowerCase()==="year"),u=n;c!==-1&&(u=n.reduce((h,f)=>{const S=f[c];if(!S.includes("-"))return h.push(f),h;let[_,v]=S.split("-").map(p=>Number(p)).reduce((p,b)=>(p.push(Number.isNaN(b)?null:b),p),[]);if(_&&v){for(let p=_;p<=v;p++)h.push(f.map((b,V)=>V===c?p:b));return h}if(!v&&_){const p=_;return h.push(f.map((b,V)=>V===c?p:b)),h}return h},[]));let g=u.map(h=>{if(a&&h.length-1!==d&&(C.error("CSV data and `filterKeys` mismatch",{filterKeys:t,line:h}),a=!1),!a)return[];let f=h[t.length];if(typeof f=="string"){f.startsWith(">>")&&(f=f.slice(2),h[t.length]=f);const y="/collections/all/";if(f.startsWith(y)&&(f=f.slice(y.length)),f.includes("$$$")){const[v]=f.split("$$$");if(v)f=v,h[t.length]=f;else return[]}}return h.reduce((y,_,v)=>{let p=t[v];if(p)y[p]=_;else if(typeof _=="string"){const b=ee(_.split("/"));y._tag=b,y._path=r({tag:b,collectionHandle:i,legacySearch:l})}return y},{})});if(!a)throw new Error("ezsearch: CSV data and `filterKeys` mismatch");return{tree:te({data:g,path:[],keys:t,keysSort:o}),parsedData:g}}class W extends U{constructor(){super(),this.onUpdate=this.onUpdate.bind(this),this.tags=null,this.elements={parentWidget:null,itemTitles:null,filteredHrefs:null}}mount(){const e=this.getAttribute("data-ezs-widget-id");if(!e)throw new Error("ezsearch-fitment: data-ezs-widget-id must be specified");if(this.tags=(this.getAttribute("data-tags")||"").split(","),!this.tags.length)throw new Error("ezsearch-fitment: data-tags must be specified");if(this.elements.parentWidget=document.getElementById(e),!this.elements.parentWidget)throw new Error("ezsearch-fitment: parent widget not found");return this.elements.itemTitles=Array.from(this.querySelectorAll("[data-ezs-item-title]")),this.elements.filteredHrefs=Array.from(this.querySelectorAll("[data-ezs-filtered-href]")),this.unsubscribe&&this.unsubscribe(),this.unsubscribe=this.elements.parentWidget.subscribe(this.onUpdate),!0}unmount(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}onUpdate({selectedItemTitle:e,filteredCollectionHref:s}){const t=this.elements.parentWidget.fits(this.tags);this.setAttribute("data-fitment-status",t);for(let i=0,r=this.elements.itemTitles.length;i<r;i++){const l=this.elements.itemTitles[i],o=typeof l.__ezs_fallback_text>"u"?l.__ezs_fallback_text=l.getAttribute("data-fallback-text"):l.__ezs_fallback_text,a=e||o;l.textContent=a,a?l.setAttribute("title",a):l.removeAttribute("title")}for(let i=0,r=this.elements.filteredHrefs.length;i<r;i++){const l=this.elements.filteredHrefs[i];l.href=s||"#"}}}window.customElements.get("ezsearch-global-v2")||window.customElements.define("ezsearch-global-v2",M),window.customElements.get("ezsearch-fitment-v2")||window.customElements.define("ezsearch-fitment-v2",W),A.EzsearchFitmentV2=W,A.EzsearchGlobalV2=M,Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
